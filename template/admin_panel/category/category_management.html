{% extends 'admin_panel/base.html' %}
{% load static %}
{% block title %}DINGDONG - Category Dashboard{% endblock %}
{% block content %}

<!-- Main Content -->
<main class="flex-1 p-6">

    <!-- Page Header --> 
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-8"> 
        <!-- Title (Left) --> 
        <h2 class="text-3xl font-bold text-gray-900">Categories</h2> 
        <!-- Right Side: Refresh + Search --> 
        <div class="flex flex-col sm:flex-row items-center gap-3"> 
            <!-- Refresh Button --> 
            {% if is_search %} 
            <a href="{% url 'admin_category' %}" class="px-4 py-2 bg-blue-600 text-white font-medium rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 transition"> 
                Refresh 
            </a> 
            {% endif %} 
            <!-- Search Form --> 
            <form action="{% url 'categories_search' %}" method="GET" class="relative"> 
                <input id="searchInput" name="keyword" type="text" value="{{ search_query }}" placeholder="Search by Category Name" class="w-full sm:w-80 px-4 py-2 pr-12 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white transition"> 
                <!-- Search Icon Button --> 
                <button id="searchBtn" type="submit" class="absolute right-3 top-1/2 -translate-y-1/2 p-1 rounded-full transition hover:bg-blue-50" title="Search"> 
                    <svg class="w-5 h-5 text-gray-400 hover:text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"> 
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/> 
                    </svg> 
                </button> 
            </form> 
        </div> 
    </div> 

    <!-- Display Messages -->
    {% if messages %}
        <div class="mb-6">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} p-4 mb-4 rounded-lg {% if message.tags == 'success' %}bg-green-100 text-green-800 border border-green-200{% elif message.tags == 'error' %}bg-red-100 text-red-800 border border-red-200{% else %}bg-blue-100 text-blue-800 border border-blue-200{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Search Results Info -->
    {% if is_search %}
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <p class="text-blue-800">
                {% if search_query %}
                    Search results for "<strong>{{ search_query }}</strong>" - {{ categories.paginator.count }} categories found
                {% else %}
                    Showing all categories - {{ categories.paginator.count }} total
                {% endif %}
            </p>
        </div>
    {% endif %}
    
    <!-- Categories Content -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <!-- ADD Category Buttons -->
        <div class="flex flex-col sm:flex-row gap-4 mb-6">
            <button id="add-btn" onclick="openAddModal()"
                class="px-6 py-2 bg-primary text-white rounded-md hover:bg-blue-700 transition-colors font-medium">
                + Add Category
            </button>
        </div>
        
        {% if categories %}
        <!-- Categories Table -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <!-- Desktop Table -->
            <div class="hidden md:block overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="text-left py-4 px-6 font-semibold text-gray-700 text-sm uppercase tracking-wider">
                                Category Name
                            </th>
                            <th class="text-center py-4 px-6 font-semibold text-gray-700 text-sm uppercase tracking-wider">
                                Status
                            </th>
                            <th class="text-center py-4 px-6 font-semibold text-gray-700 text-sm uppercase tracking-wider">
                                Actions
                            </th>
                            <th class="text-center py-4 px-6 font-semibold text-gray-700 text-sm uppercase tracking-wider">
                                Edits
                            </th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        {% for category in categories %}
                        <tr class="hover:bg-gray-50 transition-all duration-200">
                            <!-- Category Name -->
                            <td class="py-4 px-6">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                        <span class="text-blue-600 font-medium text-sm">
                                            {{ category.name|first|upper }}
                                        </span>
                                    </div>
                                    <span class="font-medium text-gray-900">{{ category.name }}</span>
                                </div>
                            </td>

                            <!-- Status -->
                            <td class="py-4 px-6 text-center">
                                {% if category.is_listed %}
                                    <span class="inline-flex items-center gap-2 px-3 py-1 bg-green-100 text-green-800 text-sm rounded-full font-medium">
                                        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                                        Listed
                                    </span>
                                {% else %}
                                    <span class="inline-flex items-center gap-2 px-3 py-1 bg-red-100 text-red-800 text-sm rounded-full font-medium">
                                        <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                                        Unlisted
                                    </span>
                                {% endif %}
                            </td>

                            <!-- Actions -->
                            <td class="py-4 px-6 text-center">
                                {% if category.is_listed %}
                                <button onclick="openConfirmModal('{{ category.id }}', 'unlist', '{{ category.name|escapejs }}')"
                                    class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 hover:shadow-md">
                                    Unlist
                                </button>
                                {% else %}
                                <button onclick="openConfirmModal('{{ category.id }}', 'list', '{{ category.name|escapejs }}')"
                                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 hover:shadow-md">
                                    List
                                </button>
                                {% endif %}
                            </td>

                            <!-- Edits -->
                            <td class="py-4 px-6 text-center">
                                <button onclick="openEditModal('{{ category.id }}', '{{ category.name|escapejs }}')"
                                    class="bg-gray-100 hover:bg-gray-200 text-gray-700 p-2 rounded-md transition-all duration-200 hover:shadow-md">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Mobile Cards (Responsive) -->
            <div class="block md:hidden">
                {% for category in categories %}
                <div class="border-b border-gray-200 p-4 last:border-b-0">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                <span class="text-blue-600 font-medium text-sm">
                                    {{ category.name|first|upper }}
                                </span>
                            </div>
                            <span class="font-medium text-gray-900">{{ category.name }}</span>
                        </div>
                        {% if category.is_listed %}
                            <span class="inline-flex items-center gap-2 px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full font-medium">
                                <div class="w-1.5 h-1.5 bg-green-500 rounded-full"></div>
                                Listed
                            </span>
                        {% else %}
                            <span class="inline-flex items-center gap-2 px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full font-medium">
                                <div class="w-1.5 h-1.5 bg-red-500 rounded-full"></div>
                                Unlisted
                            </span>
                        {% endif %}
                    </div>
                    <div class="flex justify-end space-x-2">
                        {% if category.is_listed %}
                        <button onclick="openConfirmModal('{{ category.id }}', 'unlist', '{{ category.name|escapejs }}')"
                            class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm font-medium transition-all duration-200">
                            Unlist
                        </button>
                        {% else %}
                        <button onclick="openConfirmModal('{{ category.id }}', 'list', '{{ category.name|escapejs }}')"
                            class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm font-medium transition-all duration-200">
                            List
                        </button>
                        {% endif %}
                        <button onclick="openEditModal('{{ category.id }}', '{{ category.name|escapejs }}')"
                            class="bg-gray-100 hover:bg-gray-200 text-gray-700 p-1 rounded transition-all duration-200">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if categories.has_other_pages %}
            <div class="flex items-center justify-center mt-8 space-x-2"> 
                {% if categories.has_previous %} 
                <a href="?{% if is_search and search_query %}keyword={{ search_query }}&{% endif %}page={{ categories.previous_page_number }}" class="p-2 hover:bg-gray-100 rounded-lg transition-colors duration-200"> 
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"> 
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/> 
                    </svg> 
                </a> 
                {% else %} 
                <span class="p-2 rounded-lg text-gray-400 cursor-not-allowed"> 
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"> 
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/> 
                    </svg> 
                </span> 
                {% endif %} 
                    
                {% for i in categories.paginator.page_range %} 
                    {% if categories.number == i %} 
                    <span class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium shadow-sm"> 
                        {{ i }} 
                    </span> 
                    {% else %} 
                    <a href="?{% if is_search and search_query %}keyword={{ search_query }}&{% endif %}page={{ i }}" class="px-4 py-2 hover:bg-gray-100 text-gray-700 rounded-lg font-medium transition-colors duration-200"> 
                        {{ i }} 
                    </a> 
                    {% endif %} 
                {% endfor %} 
                
                {% if categories.has_next %} 
                    <a href="?{% if is_search and search_query %}keyword={{ search_query }}&{% endif %}page={{ categories.next_page_number }}" class="p-2 hover:bg-gray-100 rounded-lg transition-colors duration-200"> 
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"> 
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/> 
                        </svg> 
                    </a> 
                {% else %} 
                <span class="p-2 rounded-lg text-gray-400 cursor-not-allowed"> 
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"> 
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/> 
                    </svg> 
                </span> 
                {% endif %} 
            </div> 
            {% endif %}
        </div>
        {% else %}
        <!-- No Categories Found -->
        <div class="text-center py-12">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No categories found</h3>
            <p class="mt-1 text-sm text-gray-500">
                {% if is_search and search_query %}
                    No categories match your search criteria.
                {% else %}
                    Get started by creating a new category.
                {% endif %}
            </p>
        </div>
        {% endif %}
        
        <!-- Include Add Modal -->
        {% include 'admin_panel/category/category_add.html' %}
        <!-- Include list/unlist Modal -->
        {% include 'admin_panel/category/category_list.html' %}
        <!-- Include Edit Modal -->
        {% include 'admin_panel/category/category_edit.html' %}
    </div>
</main>

<script>
    // -----------------------------
    // Open "Add Category" Modal
    // -----------------------------
    window.openAddModal = function () {
        const modal = document.getElementById('addModal');
        const form = document.getElementById('addCategoryForm');
        if (!modal || !form) {
            console.error('Add modal or form not found');
            return;
        }

        form.reset(); // Clear old values
        modal.classList.remove('hidden');
        
        // Focus on the input field
        const nameInput = document.getElementById('addCategoryName');
        if (nameInput) {
            setTimeout(() => nameInput.focus(), 100);
        }
    };

    // -----------------------------
    // Close "Add Category" Modal
    // -----------------------------
    window.closeAddModal = function () {
        const modal = document.getElementById('addModal');
        if (modal) {
            modal.classList.add('hidden');
        }
    };

    // -----------------------------
    // Open Confirm Modal (List/Unlist)
    // -----------------------------
    window.openConfirmModal = function (categoryId, action, categoryName) {
        console.log('Opening confirm modal:', categoryId, action, categoryName); // Debug log
        
        const modal = document.getElementById('confirmModal');
        const confirmBtn = document.getElementById('confirmActionBtn');
        const message = document.getElementById('confirmMessage');
        const icon = document.getElementById('confirmIcon');  

        if (!modal) {
            console.error('Confirm modal not found');
            return;
        }
        if (!confirmBtn) {
            console.error('Confirm button not found');
            return;
        }
        if (!message) {
            console.error('Confirm message not found');
            return;
        }
        if (!icon) {
            console.error('Confirm icon not found');
            return;
        }

        // Update message and button style based on action
        if (action === 'list') {
            message.textContent = `Are you sure you want to list "${categoryName}"?`;
            confirmBtn.className = "px-4 py-2 rounded-lg text-white bg-green-500 hover:bg-green-600 font-medium transition-colors";
            confirmBtn.textContent = "List";
            icon.innerHTML = `
                <div class="w-16 h-16 mx-auto bg-green-100 rounded-full flex items-center justify-center">
                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
            `;
        } else if (action === 'unlist') {
            message.textContent = `Are you sure you want to unlist "${categoryName}"?`;
            confirmBtn.className = "px-4 py-2 rounded-lg text-white bg-red-500 hover:bg-red-600 font-medium transition-colors";
            confirmBtn.textContent = "Unlist";
            icon.innerHTML = `
                <div class="w-16 h-16 mx-auto bg-red-100 rounded-full flex items-center justify-center">
                    <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L18.364 5.636M5.636 18.364l12.728-12.728"/>
                    </svg>
                </div>
            `;
        } else {
            console.error('Invalid action:', action);
            return;
        }

        // Set confirm button href dynamically
        let actionUrl = "{% url 'category_status' 0 'ACTION' %}"
            .replace("0", categoryId)
            .replace("ACTION", action);

        confirmBtn.setAttribute("href", actionUrl);
        console.log('Setting action URL:', actionUrl); // Debug log

        // Show the modal
        modal.classList.remove('hidden');
    };

    // -----------------------------
    // Close Confirm Modal
    // -----------------------------
    window.closeConfirmModal = function () {
        const modal = document.getElementById('confirmModal');
        if (modal) {
            modal.classList.add('hidden');
        }
    };

    // -----------------------------
    // Open Edit Modal
    // -----------------------------
    window.openEditModal = function (categoryId, categoryName) {
        console.log('Opening edit modal:', categoryId, categoryName); // Debug log
        
        const modal = document.getElementById('editModal');
        const categoryIdInput = document.getElementById('editCategoryId');
        const categoryNameInput = document.getElementById('editCategoryName');

        if (!modal) {
            console.error('Edit modal not found');
            return;
        }
        if (!categoryIdInput) {
            console.error('Category ID input not found');
            return;
        }
        if (!categoryNameInput) {
            console.error('Category name input not found');
            return;
        }

        // Pre-fill modal fields
        categoryIdInput.value = categoryId;
        categoryNameInput.value = categoryName;

        modal.classList.remove('hidden');
        
        // Focus on the name input
        setTimeout(() => categoryNameInput.focus(), 100);
    };

    // -----------------------------
    // Close Edit Modal
    // -----------------------------
    window.closeEditModal = function () {
        const modal = document.getElementById('editModal');
        if (modal) {
            modal.classList.add('hidden');
        }
    };

    // -----------------------------
    // Close Modals on Click Outside
    // -----------------------------
    document.addEventListener('click', function (e) {
        const confirmModal = document.getElementById('confirmModal');
        const editModal = document.getElementById('editModal');
        const addModal = document.getElementById('addModal');

        // Close modals when clicking on the backdrop (not the modal content)
        if (e.target === confirmModal) {
            closeConfirmModal();
        }
        if (e.target === editModal) {
            closeEditModal();
        }
        if (e.target === addModal) {
            closeAddModal();
        }
    });

    // -----------------------------
    // Keyboard Event Handlers
    // -----------------------------
    document.addEventListener('keydown', function (e) {
        // Close modals on Escape key
        if (e.key === 'Escape') {
            closeConfirmModal();
            closeEditModal();
            closeAddModal();
        }
    });

    // -----------------------------
    // Debug: Check if all required elements exist on page load
    // -----------------------------
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Page loaded, checking modal elements...');
        
        const requiredElements = [
            'addModal',
            'confirmModal', 
            'editModal',
            'confirmActionBtn',
            'confirmMessage',
            'confirmIcon'
        ];
        
        requiredElements.forEach(id => {
            const element = document.getElementById(id);
            if (!element) {
                console.error(`Required element missing: ${id}`);
            } else {
                console.log(`Found element: ${id}`);
            }
        });
    });
</script>

{% endblock %}