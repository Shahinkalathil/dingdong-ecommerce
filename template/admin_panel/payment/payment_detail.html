{% extends 'admin_panel/base.html'%} 
{% load static %} 
{% block title %}DINGDONG - Payment Detail{% endblock %} 
{% block content %}

<style>
    /* Custom scrollbar */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    ::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    ::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
</style>

<div class="container mx-auto px-4 py-8">
    <!-- Back Button -->
    <div class="mb-4">
        <a href="{% url 'admin_payment_management' %}" class="inline-flex items-center text-blue-500 hover:text-blue-700">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Back to Payment Management
        </a>
    </div>

    {% if payment_type == 'order' %}
    <!-- ORDER PAYMENT DETAIL -->
    
    <!-- Payment Header -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Order Payment Details</h1>
                <p class="text-gray-600 mt-1">Transaction ID: {{ transaction_id }}</p>
            </div>
            <div class="text-right">
                <p class="text-sm text-gray-600">Total Amount</p>
                <p class="text-3xl font-bold text-green-600">₹{{ order.total_amount|floatformat:2 }}</p>
            </div>
        </div>

        <!-- Payment Status Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="p-4 bg-gray-50 rounded-lg">
                <p class="text-sm text-gray-600 mb-1">Order Number</p>
                <p class="font-bold text-gray-900">{{ order.order_number }}</p>
            </div>
            <div class="p-4 bg-gray-50 rounded-lg">
                <p class="text-sm text-gray-600 mb-1">Payment Method</p>
                <p class="font-bold text-gray-900">{{ order.get_payment_method_display }}</p>
            </div>
            <div class="p-4 bg-gray-50 rounded-lg">
                <p class="text-sm text-gray-600 mb-1">Payment Status</p>
                <p class="font-bold">
                    {% if order.payment_status == 'paid' %}
                    <span class="text-green-600">Paid</span>
                    {% elif order.payment_status == 'pending' %}
                    <span class="text-yellow-600">Pending</span>
                    {% elif order.payment_status == 'refunded' %}
                    <span class="text-red-600">Refunded</span>
                    {% else %}
                    <span class="text-gray-600">{{ order.payment_status|title }}</span>
                    {% endif %}
                </p>
            </div>
            <div class="p-4 bg-gray-50 rounded-lg">
                <p class="text-sm text-gray-600 mb-1">Order Status</p>
                <p class="font-bold text-gray-900">{{ order.get_order_status_display }}</p>
            </div>
        </div>
    </div>

    <!-- Customer Information -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Customer Information</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <p class="text-sm text-gray-600">Customer Name</p>
                <p class="font-medium text-gray-900">{{ order.user.get_full_name|default:order.user.username }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-600">Email</p>
                <p class="font-medium text-gray-900">{{ order.user.email }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-600">Phone</p>
                <p class="font-medium text-gray-900">
                    {% if order.delivery_address %}
                    {{ order.delivery_address.phone_number }}
                    {% else %}
                    -
                    {% endif %}
                </p>
            </div>
            <div>
                <p class="text-sm text-gray-600">Order Date</p>
                <p class="font-medium text-gray-900">{{ order.created_at|date:"M d, Y H:i" }}</p>
            </div>
        </div>
    </div>

    <!-- Payment Details -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Payment Details</h2>
        
        <div class="space-y-3">
            <div class="flex justify-between py-2 border-b border-gray-200">
                <span class="text-gray-600">Subtotal</span>
                <span class="font-medium text-gray-900">₹{{ order.subtotal|floatformat:2 }}</span>
            </div>
            
            {% if order.delivery_charge %}
            <div class="flex justify-between py-2 border-b border-gray-200">
                <span class="text-gray-600">Delivery Charge</span>
                <span class="font-medium text-gray-900">₹{{ order.delivery_charge|floatformat:2 }}</span>
            </div>
            {% endif %}
            
            {% if order.discount_amount %}
            <div class="flex justify-between py-2 border-b border-gray-200">
                <span class="text-gray-600">Discount</span>
                <span class="font-medium text-red-600">-₹{{ order.discount_amount|floatformat:2 }}</span>
            </div>
            {% endif %}
            
            {% if order.coupon_discount %}
            <div class="flex justify-between py-2 border-b border-gray-200">
                <span class="text-gray-600">Coupon Discount ({{ order.coupon_code }})</span>
                <span class="font-medium text-red-600">-₹{{ order.coupon_discount|floatformat:2 }}</span>
            </div>
            {% endif %}
            
            <div class="flex justify-between py-3 bg-gray-50 px-4 rounded-lg">
                <span class="font-bold text-gray-900 text-lg">Total Amount</span>
                <span class="font-bold text-green-600 text-lg">₹{{ order.total_amount|floatformat:2 }}</span>
            </div>
        </div>

        {% if order.razorpay_payment_id or order.payment_id %}
        <div class="mt-4 p-4 bg-gray-50 rounded-lg">
            <h3 class="font-semibold text-gray-900 mb-2">Transaction Details</h3>
            {% if order.razorpay_order_id %}
            <p class="text-sm text-gray-600">Razorpay Order ID: <span class="font-medium text-gray-900">{{ order.razorpay_order_id }}</span></p>
            {% endif %}
            {% if order.razorpay_payment_id %}
            <p class="text-sm text-gray-600">Razorpay Payment ID: <span class="font-medium text-gray-900">{{ order.razorpay_payment_id }}</span></p>
            {% endif %}
            {% if order.payment_id %}
            <p class="text-sm text-gray-600">Payment ID: <span class="font-medium text-gray-900">{{ order.payment_id }}</span></p>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- Order Items -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Order Items</h2>
        
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-200">
                    <tr>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Product</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Color</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Price</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Quantity</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Subtotal</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Status</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for item in items %}
                    <tr>
                        <td class="px-4 py-3 text-sm text-gray-900">{{ item.product_name }}</td>
                        <td class="px-4 py-3 text-sm">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded border border-gray-300" style="background-color: {{ item.color_code }};"></div>
                                <span class="text-gray-900">{{ item.color_name }}</span>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900">₹{{ item.price|floatformat:2 }}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">{{ item.quantity }}</td>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">₹{{ item.subtotal|floatformat:2 }}</td>
                        <td class="px-4 py-3 text-sm">
                            {% if item.item_status == 'active' %}
                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                Active
                            </span>
                            {% elif item.item_status == 'cancelled' %}
                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                Cancelled
                            </span>
                            {% elif item.item_status == 'returned' %}
                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                                Returned
                            </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Delivery Address -->
    {% if order.delivery_address %}
    <div class="bg-white rounded-lg shadow-sm p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Delivery Address</h2>
        <div class="p-4 bg-gray-50 rounded-lg">
            <p class="font-medium text-gray-900">{{ order.delivery_address.full_name }}</p>
            <p class="text-gray-600 mt-1">{{ order.delivery_address.phone_number }}</p>
            <p class="text-gray-600 mt-2">
                {{ order.delivery_address.flat_house }}, {{ order.delivery_address.area_street }}<br>
                {% if order.delivery_address.landmark %}{{ order.delivery_address.landmark }}<br>{% endif %}
                {{ order.delivery_address.town_city }}, {{ order.delivery_address.state }} - {{ order.delivery_address.pincode }}
            </p>
        </div>
    </div>
    {% endif %}

    {% elif payment_type == 'wallet' %}
    <!-- WALLET TRANSACTION DETAIL -->
    
    <!-- Transaction Header -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Wallet Transaction Details</h1>
                <p class="text-gray-600 mt-1">Transaction ID: {{ transaction_id }}</p>
            </div>
            <div class="text-right">
                <p class="text-sm text-gray-600">Amount</p>
                {% if transaction.transaction_type == 'credit' %}
                <p class="text-3xl font-bold text-green-600">+₹{{ transaction.amount|floatformat:2 }}</p>
                {% else %}
                <p class="text-3xl font-bold text-red-600">-₹{{ transaction.amount|floatformat:2 }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Transaction Status Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="p-4 bg-gray-50 rounded-lg">
                <p class="text-sm text-gray-600 mb-1">Transaction Type</p>
                <p class="font-bold">
                    {% if transaction.transaction_type == 'credit' %}
                    <span class="text-green-600">Credit</span>
                    {% else %}
                    <span class="text-red-600">Debit</span>
                    {% endif %}
                </p>
            </div>
            <div class="p-4 bg-gray-50 rounded-lg">
                <p class="text-sm text-gray-600 mb-1">Transaction Date</p>
                <p class="font-bold text-gray-900">{{ transaction.created_at|date:"M d, Y H:i" }}</p>
            </div>
            <div class="p-4 bg-gray-50 rounded-lg">
                <p class="text-sm text-gray-600 mb-1">Status</p>
                <p class="font-bold text-green-600">Completed</p>
            </div>
        </div>
    </div>

    <!-- Wallet Information -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Wallet Information</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <p class="text-sm text-gray-600">Wallet Owner</p>
                <p class="font-medium text-gray-900">{{ wallet.user.get_full_name|default:wallet.user.username }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-600">Email</p>
                <p class="font-medium text-gray-900">{{ wallet.user.email }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-600">Wallet ID</p>
                <p class="font-medium text-gray-900">#{{ wallet.id }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-600">Current Balance</p>
                <p class="font-medium text-green-600">₹{{ wallet.balance|floatformat:2 }}</p>
            </div>
        </div>
    </div>

    <!-- Transaction Details -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Transaction Details</h2>
        
        <div class="space-y-4">
            <div class="p-4 bg-gray-50 rounded-lg">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-600">Transaction ID</p>
                        <p class="font-medium text-gray-900">{{ transaction_id }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Transaction Type</p>
                        <p class="font-medium">
                            {% if transaction.transaction_type == 'credit' %}
                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                Credit
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                Debit
                            </span>
                            {% endif %}
                        </p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Amount</p>
                        <p class="font-medium">
                            {% if transaction.transaction_type == 'credit' %}
                            <span class="text-green-600">+₹{{ transaction.amount|floatformat:2 }}</span>
                            {% else %}
                            <span class="text-red-600">-₹{{ transaction.amount|floatformat:2 }}</span>
                            {% endif %}
                        </p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Date & Time</p>
                        <p class="font-medium text-gray-900">{{ transaction.created_at|date:"M d, Y H:i:s" }}</p>
                    </div>
                </div>
            </div>

            {% if transaction.order %}
            <div class="p-4 border-2 border-blue-100 rounded-lg">
                <h3 class="font-semibold text-gray-900 mb-3">Related Order</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <p class="text-sm text-gray-600">Order Number</p>
                        <p class="font-medium text-blue-600">{{ transaction.order.order_number }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Order Amount</p>
                        <p class="font-medium text-gray-900">₹{{ transaction.order.total_amount|floatformat:2 }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Order Status</p>
                        <p class="font-medium text-gray-900">{{ transaction.order.get_order_status_display }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Order Date</p>
                        <p class="font-medium text-gray-900">{{ transaction.order.created_at|date:"M d, Y" }}</p>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="p-4 bg-blue-50 rounded-lg">
                <p class="text-sm text-blue-800">
                    <strong>Note:</strong> This is a standalone wallet transaction not associated with any order. 
                    {% if transaction.transaction_type == 'credit' %}
                    This could be a wallet top-up or refund.
                    {% else %}
                    This could be a wallet payment or withdrawal.
                    {% endif %}
                </p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Transaction Summary -->
    <div class="bg-white rounded-lg shadow-sm p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Transaction Summary</h2>
        
        <div class="space-y-3">
            <div class="flex justify-between py-2 border-b border-gray-200">
                <span class="text-gray-600">Transaction Type</span>
                <span class="font-medium text-gray-900">{{ transaction.get_transaction_type_display }}</span>
            </div>
            
            <div class="flex justify-between py-2 border-b border-gray-200">
                <span class="text-gray-600">Wallet Owner</span>
                <span class="font-medium text-gray-900">{{ wallet.user.username }}</span>
            </div>
            
            <div class="flex justify-between py-2 border-b border-gray-200">
                <span class="text-gray-600">Payment Method</span>
                <span class="font-medium text-gray-900">Wallet</span>
            </div>
            
            <div class="flex justify-between py-3 bg-gray-50 px-4 rounded-lg">
                <span class="font-bold text-gray-900 text-lg">Amount</span>
                {% if transaction.transaction_type == 'credit' %}
                <span class="font-bold text-green-600 text-lg">+₹{{ transaction.amount|floatformat:2 }}</span>
                {% else %}
                <span class="font-bold text-red-600 text-lg">-₹{{ transaction.amount|floatformat:2 }}</span>
                {% endif %}
            </div>

            <div class="flex justify-between py-2 bg-blue-50 px-4 rounded-lg mt-3">
                <span class="font-medium text-gray-900">Current Wallet Balance</span>
                <span class="font-bold text-green-600">₹{{ wallet.balance|floatformat:2 }}</span>
            </div>
        </div>
    </div>

    {% endif %}
</div>
{% endblock %}