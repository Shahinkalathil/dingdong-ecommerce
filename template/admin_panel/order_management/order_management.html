{% extends 'admin_panel/base.html' %}
{% load static %}
{% block title %}DINGDONG - Order Management{% endblock %}

{% block content %}

    <div class="min-h-screen p-4 md:p-8">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Order Management</h1>
                <p class="text-gray-600">Track and manage your orders</p>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-sm p-6 border-l-4 border-blue-500">
                    <p class="text-gray-600 text-sm font-medium mb-1">Total Revenue</p>
                    <p class="text-3xl font-bold text-gray-900">₹{{ total_revenue|floatformat:2 }}</p>
                    <p class="text-green-600 text-sm mt-2">From paid orders</p>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-6 border-l-4 border-green-500">
                    <p class="text-gray-600 text-sm font-medium mb-1">Completed Orders</p>
                    <p class="text-3xl font-bold text-gray-900">{{ completed_orders }}</p>
                    <p class="text-gray-600 text-sm mt-2">Successfully delivered</p>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-6 border-l-4 border-orange-500">
                    <p class="text-gray-600 text-sm font-medium mb-1">Pending Payment</p>
                    <p class="text-3xl font-bold text-gray-900">₹{{ pending_payment_amount|floatformat:2 }}</p>
                    <p class="text-orange-600 text-sm mt-2">{{ pending_payment_count }} orders awaiting</p>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-6 border-l-4 border-purple-500">
                    <p class="text-gray-600 text-sm font-medium mb-1">Payment Status</p>
                    <div class="flex gap-2 mt-3">
                        <div class="text-center flex-1">
                            <p class="text-xl font-bold text-green-600">{{ paid_count }}</p>
                            <p class="text-xs text-gray-600">Paid</p>
                        </div>
                        <div class="text-center flex-1">
                            <p class="text-xl font-bold text-yellow-600">{{ pending_count }}</p>
                            <p class="text-xs text-gray-600">Pending</p>
                        </div>
                        <div class="text-center flex-1">
                            <p class="text-xl font-bold text-red-600">{{ failed_count }}</p>
                            <p class="text-xs text-gray-600">Failed</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center bg-white rounded-lg shadow-sm p-4 mb-6 gap-4">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-900">Orders</h2>
                
                <form method="GET" class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 w-full sm:w-auto">
                    <input type="text" name="search" value="{{ search_query }}" placeholder="Search Order ID..." 
                           class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-full sm:w-auto">
                    <select name="status" id="statusFilter" onchange="this.form.submit()"
                            class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                        <option value="">All Status</option>
                        {% for value, label in status_choices %}
                        <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">Search</button>
                </form>
            </div>

            <!-- Orders Table -->
            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100 border-b border-gray-200">
                            <tr>
                                <th class="px-4 md:px-6 py-3 text-left font-semibold text-gray-900">Order ID</th>
                                <th class="px-4 md:px-6 py-3 text-left font-semibold text-gray-900 hidden sm:table-cell">Customer</th>
                                <th class="px-4 md:px-6 py-3 text-left font-semibold text-gray-900 hidden md:table-cell">Items</th>
                                <th class="px-4 md:px-6 py-3 text-left font-semibold text-gray-900">Amount</th>
                                <th class="px-4 md:px-6 py-3 text-left font-semibold text-gray-900 hidden lg:table-cell">Payment</th>
                                <th class="px-4 md:px-6 py-3 text-left font-semibold text-gray-900">Status</th>
                                <th class="px-4 md:px-6 py-3 text-center font-semibold text-gray-900">Action</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            {% for order in orders %}
                            <tr class="hover:bg-gray-50 transition" data-order-row="{{ order.id }}">
                                <td class="px-4 md:px-6 py-4 font-semibold text-gray-900">{{ order.order_number }}</td>
                                <td class="px-4 md:px-6 py-4 text-gray-700 hidden sm:table-cell">{{ order.user.username }}</td>
                                <td class="px-4 md:px-6 py-4 text-gray-700 hidden md:table-cell">{{ order.items.count }} item(s)</td>
                                <td class="px-4 md:px-6 py-4 text-gray-700">₹{{ order.total_amount|floatformat:2 }}</td>
                                <td class="px-4 md:px-6 py-4 hidden lg:table-cell" data-payment-status="{{ order.id }}">
                                    {% if order.payment_status == 'paid' %}
                                    <span class="text-green-600 bg-green-50 px-3 py-1 rounded-full text-sm font-medium">Paid</span>
                                    {% elif order.payment_status == 'pending' %}
                                    <span class="text-yellow-600 bg-yellow-50 px-3 py-1 rounded-full text-sm font-medium">Pending</span>
                                    {% elif order.payment_status == 'failed' %}
                                    <span class="text-red-600 bg-red-50 px-3 py-1 rounded-full text-sm font-medium">Failed</span>
                                    {% elif order.payment_status == 'refunded' %}
                                    <span class="text-purple-600 bg-purple-50 px-3 py-1 rounded-full text-sm font-medium">Refunded</span>
                                    {% else %}
                                    <span class="text-gray-600 bg-gray-50 px-3 py-1 rounded-full text-sm font-medium">{{ order.payment_status|title }}</span>
                                    {% endif %}
                                </td>
                                <td class="px-4 md:px-6 py-4" data-order-status="{{ order.id }}">
                                    {% if order.order_status == 'cancelled' %}
                                        <span class="text-red-600 bg-red-50 px-3 py-1 rounded-full text-sm font-medium">Cancelled</span>
                                    {% elif order.order_status == 'returned' %}
                                        <span class="text-purple-600 bg-purple-50 px-3 py-1 rounded-full text-sm font-medium">Returned</span>
                                    {% elif order.order_status == 'delivered' %}
                                        <span class="text-green-600 bg-green-50 px-3 py-1 rounded-full text-sm font-medium">Delivered</span>
                                    {% elif order.order_status == 'confirmed' %}
                                        <select class="order-status-select px-2 py-1 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"
                                                data-order-id="{{ order.id }}" data-current-status="{{ order.order_status }}">
                                            <option value="confirmed" selected>Confirmed</option>
                                            <option value="shipped">Shipped</option>
                                        </select>
                                    {% elif order.order_status == 'shipped' %}
                                        <select class="order-status-select px-2 py-1 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"
                                                data-order-id="{{ order.id }}" data-current-status="{{ order.order_status }}">
                                            <option value="shipped" selected>Shipped</option>
                                            <option value="out_for_delivery">Out for Delivery</option>
                                        </select>
                                    {% elif order.order_status == 'out_for_delivery' %}
                                        <select class="order-status-select px-2 py-1 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"
                                                data-order-id="{{ order.id }}" data-current-status="{{ order.order_status }}">
                                            <option value="out_for_delivery" selected>Out for Delivery</option>
                                            <option value="delivered">Delivered</option>
                                        </select>
                                    {% elif order.order_status == 'returned_checking' %}
                                        <select class="return-status-select px-2 py-1 border border-orange-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-500 bg-orange-50"
                                                data-order-id="{{ order.id }}" data-current-status="{{ order.order_status }}">
                                            <option value="returned_checking" selected>Return Checking</option>
                                            <option value="approved">Approve Return</option>
                                            <option value="rejected">Reject Return</option>
                                        </select>
                                    {% else %}
                                        <span class="text-gray-600 bg-gray-50 px-3 py-1 rounded-full text-sm font-medium">{{ order.order_status|title }}</span>
                                    {% endif %}
                                </td>
                                <td class="px-4 md:px-6 py-4 text-center">
                                    <a href="{% url 'admin_order_details' order.id %}" class="inline-flex items-center justify-center w-8 h-8 rounded-lg hover:bg-gray-200 transition" title="View Details">
                                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">No orders found</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                {% if orders.has_other_pages %}
                <div class="px-4 md:px-6 py-4 flex flex-col sm:flex-row items-center justify-between border-t border-gray-200 bg-gray-50 gap-4">
                    <p class="text-sm text-gray-600">Showing {{ orders.start_index }} to {{ orders.end_index }} of {{ orders.paginator.count }} orders</p>
                    <div class="flex gap-2">
                        {% if orders.has_previous %}
                        <a href="?page={{ orders.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}" 
                           class="px-3 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 transition text-sm">←</a>
                        {% else %}
                        <button disabled class="px-3 py-2 rounded-lg border border-gray-300 text-gray-400 text-sm cursor-not-allowed">←</button>
                        {% endif %}
                        
                        {% for num in orders.paginator.page_range %}
                            {% if orders.number == num %}
                            <span class="px-3 py-2 rounded-lg bg-blue-500 text-white text-sm">{{ num }}</span>
                            {% elif num > orders.number|add:'-3' and num < orders.number|add:'3' %}
                            <a href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}" 
                               class="px-3 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 transition text-sm">{{ num }}</a>
                            {% endif %}
                        {% endfor %}
                        
                        {% if orders.has_next %}
                        <a href="?page={{ orders.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}" 
                           class="px-3 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 transition text-sm">→</a>
                        {% else %}
                        <button disabled class="px-3 py-2 rounded-lg border border-gray-300 text-gray-400 text-sm cursor-not-allowed">→</button>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="statusModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6 transform transition-all">
            <div class="flex items-center justify-center w-12 h-12 mx-auto bg-blue-100 rounded-full mb-4">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 text-center mb-2">Confirm Status Change</h3>
            <p class="text-gray-600 text-center mb-2" id="modalMessage">Are you sure you want to change the order status?</p>
            <p class="text-sm text-blue-600 text-center mb-4" id="modalNote" style="display: none;">
            </p>
            <div class="flex gap-3">
                <button id="cancelBtn" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition font-medium">Cancel</button>
                <button id="confirmBtn" class="flex-1 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition font-medium">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Success/Error Toast -->
    <div id="toast" class="hidden fixed top-4 right-4 z-50 max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto overflow-hidden">
        <div class="p-4">
            <div class="flex items-start">
                <div class="flex-shrink-0" id="toastIcon"></div>
                <div class="ml-3 w-0 flex-1">
                    <p class="text-sm font-medium text-gray-900" id="toastTitle"></p>
                    <p class="mt-1 text-sm text-gray-500" id="toastMessage"></p>
                </div>
                <button onclick="closeToast()" class="ml-4 flex-shrink-0 inline-flex text-gray-400 hover:text-gray-500">
                    <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
    let currentSelect = null;
    let currentOrderId = null;
    let currentNewStatus = null;
    let currentOldStatus = null;
    let isReturnAction = false;

    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('statusModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalNote = document.getElementById('modalNote');
        const confirmBtn = document.getElementById('confirmBtn');
        const cancelBtn = document.getElementById('cancelBtn');

        // Handle regular order status changes
        document.querySelectorAll('.order-status-select').forEach(select => {
            select.addEventListener('change', function() {
                const orderId = this.dataset.orderId;
                const currentStatus = this.dataset.currentStatus;
                const newStatus = this.value;
                
                if (newStatus === currentStatus) return;
                
                currentSelect = this;
                currentOrderId = orderId;
                currentNewStatus = newStatus;
                currentOldStatus = currentStatus;
                isReturnAction = false;
                
                const formatStatus = (status) => status.replace(/_/g, ' ').split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                
                modalMessage.textContent = `Are you sure you want to change the order status from "${formatStatus(currentStatus)}" to "${formatStatus(newStatus)}"?`;
                
                if (newStatus === 'delivered') {
                    modalNote.style.display = 'block';
                } else {
                    modalNote.style.display = 'none';
                }
                
                modal.classList.remove('hidden');
            });
        });

        // Handle return status changes
        document.querySelectorAll('.return-status-select').forEach(select => {
            select.addEventListener('change', function() {
                const orderId = this.dataset.orderId;
                const currentStatus = this.dataset.currentStatus;
                const newStatus = this.value;
                
                if (newStatus === currentStatus) return;
                
                currentSelect = this;
                currentOrderId = orderId;
                currentNewStatus = newStatus;
                currentOldStatus = currentStatus;
                isReturnAction = true;
                
                if (newStatus === 'approved') {
                    modalMessage.textContent = 'Are you sure you want to approve this return? The refund amount will be added to the customer\'s wallet.';
                    modalNote.textContent = 'Order status will be set to "Returned" and payment status to "Refunded".';
                    modalNote.style.display = 'block';
                } else if (newStatus === 'rejected') {
                    modalMessage.textContent = 'Are you sure you want to reject this return request?';
                    modalNote.textContent = 'The order will remain in its current state.';
                    modalNote.style.display = 'block';
                }
                
                modal.classList.remove('hidden');
            });
        });

        cancelBtn.addEventListener('click', function() {
            if (currentSelect && currentOldStatus) {
                currentSelect.value = currentOldStatus;
            }
            modal.classList.add('hidden');
            modalNote.style.display = 'none';
            resetModalState();
        });

        confirmBtn.addEventListener('click', function() {
            modal.classList.add('hidden');
            modalNote.style.display = 'none';
            
            if (isReturnAction) {
                handleReturnAction();
            } else {
                updateOrderStatus();
            }
        });

        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                if (currentSelect && currentOldStatus) {
                    currentSelect.value = currentOldStatus;
                }
                modal.classList.add('hidden');
                modalNote.style.display = 'none';
                resetModalState();
            }
        });
    });

    function handleReturnAction() {
        if (!currentOrderId || !currentNewStatus) {
            showToast('Error', 'Invalid order data', 'error');
            return;
        }

        const confirmBtn = document.getElementById('confirmBtn');
        const originalText = confirmBtn.textContent;
        confirmBtn.textContent = 'Processing...';
        confirmBtn.disabled = true;

        fetch(`/orders/admin-management/handle-return/${currentOrderId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `action=${currentNewStatus}`
        })
        .then(response => {
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Server returned non-JSON response. Please check the URL configuration.');
            }
            
            return response.json().then(data => {
                if (!response.ok) {
                    throw new Error(data.message || 'Failed to process return');
                }
                return data;
            });
        })
        .then(data => {
            if (data.success) {
                showToast('Success', data.message, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast('Error', data.message, 'error');
                if (currentSelect && currentOldStatus) {
                    currentSelect.value = currentOldStatus;
                }
            }
            confirmBtn.textContent = originalText;
            confirmBtn.disabled = false;
            resetModalState();
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error', error.message || 'An error occurred while processing the return.', 'error');
            if (currentSelect && currentOldStatus) {
                currentSelect.value = currentOldStatus;
            }
            confirmBtn.textContent = originalText;
            confirmBtn.disabled = false;
            resetModalState();
        });
    }

    function updateOrderStatus() {
        if (!currentOrderId || !currentNewStatus) {
            showToast('Error', 'Invalid order data', 'error');
            return;
        }

        const confirmBtn = document.getElementById('confirmBtn');
        const originalText = confirmBtn.textContent;
        confirmBtn.textContent = 'Updating...';
        confirmBtn.disabled = true;

        fetch(`/orders/admin-management/update-status/${currentOrderId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `status=${currentNewStatus}`
        })
        .then(response => {
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Server returned non-JSON response. Please check the URL configuration.');
            }
            
            return response.json().then(data => {
                if (!response.ok) {
                    throw new Error(data.message || 'Failed to update status');
                }
                return data;
            });
        })
        .then(data => {
            if (data.success) {
                let message = data.message;
                if (currentNewStatus === 'delivered' && data.payment_updated) {
                    message += ' and payment marked as Paid';
                }
                showToast('Success', message, 'success');
                
                if (currentSelect) {
                    currentSelect.dataset.currentStatus = currentNewStatus;
                    
                    const statusCell = document.querySelector(`[data-order-status="${currentOrderId}"]`);
                    if (statusCell && currentNewStatus === 'delivered') {
                        statusCell.innerHTML = '<span class="text-green-600 bg-green-50 px-3 py-1 rounded-full text-sm font-medium">Delivered</span>';
                    }
                    
                    if (currentNewStatus === 'delivered') {
                        const paymentCell = document.querySelector(`[data-payment-status="${currentOrderId}"]`);
                        if (paymentCell) {
                            paymentCell.innerHTML = '<span class="text-green-600 bg-green-50 px-3 py-1 rounded-full text-sm font-medium">Paid</span>';
                        }
                    }
                }
                
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast('Error', data.message, 'error');
                if (currentSelect && currentOldStatus) {
                    currentSelect.value = currentOldStatus;
                }
            }
            confirmBtn.textContent = originalText;
            confirmBtn.disabled = false;
            resetModalState();
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error', error.message || 'An error occurred while updating the order status.', 'error');
            if (currentSelect && currentOldStatus) {
                currentSelect.value = currentOldStatus;
            }
            confirmBtn.textContent = originalText;
            confirmBtn.disabled = false;
            resetModalState();
        });
    }

    function resetModalState() {
        currentSelect = null;
        currentOrderId = null;
        currentNewStatus = null;
        currentOldStatus = null;
        isReturnAction = false;
    }

    function showToast(title, message, type) {
        const toast = document.getElementById('toast');
        const toastTitle = document.getElementById('toastTitle');
        const toastMessage = document.getElementById('toastMessage');
        const toastIcon = document.getElementById('toastIcon');
        
        toastTitle.textContent = title;
        toastMessage.textContent = message;
        
        if (type === 'success') {
            toastIcon.innerHTML = '<svg class="h-6 w-6 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';
        } else {
            toastIcon.innerHTML = '<svg class="h-6 w-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';
        }
        
        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), 5000);
    }

    function closeToast() {
        document.getElementById('toast').classList.add('hidden');
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    </script>

{% endblock %}